<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookiejar Research App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(139, 69, 19, 0.95);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .cookie-icon {
            width: 35px;
            height: 35px;
            margin-right: 10px;
            background: #d2691e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .credits {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .tier-badge {
            background: linear-gradient(45deg, #6c757d, #868e96);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-cookie {
            font-size: 4rem;
            animation: loadingBounce 1s infinite ease-in-out;
            margin-bottom: 1rem;
        }

        @keyframes loadingBounce {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 20px;
        }

        .research-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .research-input-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .research-input-section h1 {
            color: #8b4513;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .research-input-section p {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .input-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .research-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 1.1rem;
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s;
        }

        .research-input:focus {
            outline: none;
            border-color: #8b4513;
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.2);
        }

        .input-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8b4513, #d2691e);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(45deg, #ccc, #999);
        }

        .btn-secondary {
            background: transparent;
            color: #8b4513;
            border: 2px solid #8b4513;
        }

        .btn-secondary:hover {
            background: #8b4513;
            color: white;
        }

        .processing-section {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .cookie-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cookie {
            font-size: 8rem;
            animation: cookieBounce 2s infinite ease-in-out;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
            user-select: none;
        }

        @keyframes cookieBounce {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }

        .processing-steps {
            text-align: left;
            max-width: 400px;
            margin: 2rem auto 0;
        }

        .processing-step {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
            opacity: 0.3;
            transition: opacity 0.5s ease-in-out;
        }

        .processing-step.active {
            opacity: 1;
        }

        .processing-step.completed {
            opacity: 0.7;
        }

        .step-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .processing-step.active .step-icon {
            background: #8b4513;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .processing-step.completed .step-icon {
            background: #28a745;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .results-section {
            display: none;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #8b4513;
        }

        .result-stats {
            display: flex;
            gap: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .stat {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            flex: 1;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8b4513;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ff9999;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #cc0000;
        }

        .error h3 {
            margin-bottom: 0.5rem;
        }

        /* Research Summary Styles */
        .research-summary-header h3 {
            color: #8b4513;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 0.5rem;
        }

        .summary-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid #8b4513;
        }

        .summary-section {
            margin-bottom: 1.5rem;
        }

        .summary-section:last-child {
            margin-bottom: 0;
        }

        .summary-heading {
            color: #6b4423;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ddd;
        }

        .summary-content {
            line-height: 1.7;
            color: #333;
            font-size: 1rem;
            text-align: justify;
        }

        /* Sources Section Styles */
        .sources-section h3 {
            color: #8b4513;
            margin: 2rem 0 1rem 0;
            font-size: 1.3rem;
        }

        .sources-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .source-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            transition: box-shadow 0.2s ease;
        }

        .source-card:hover {
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.1);
        }

        .source-number {
            background: #8b4513;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .source-content {
            flex: 1;
        }

        .source-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .source-meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.25rem;
        }

        .source-authors {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .source-quote {
            font-size: 0.9rem;
            color: #555;
            font-style: italic;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #8b4513;
        }

        .source-link {
            font-size: 0.85rem;
            color: #8b4513;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .source-link:hover {
            color: #d2691e;
            text-decoration: underline;
        }

        .download-section {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #8b4513, #d2691e);
            color: white;
            border-radius: 15px;
            margin-top: 2rem;
        }

        .upgrade-prompt {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 2rem 0;
            text-align: center;
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upgrade-prompt h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .upgrade-prompt p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .input-validation {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .validation-message {
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .validation-error {
            background: #ffe6e6;
            color: #cc0000;
            border-left: 3px solid #cc0000;
        }

        .validation-success {
            background: #e6f7e6;
            color: #006600;
            border-left: 3px solid #006600;
        }

        .validation-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #856404;
        }

        /* Progress bar for processing */
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 2rem auto;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #8b4513, #d2691e);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0 10px;
            }
            
            .research-card {
                padding: 1rem;
            }
            
            .input-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .result-stats {
                flex-direction: column;
                gap: 1rem;
            }
            
            .cookie {
                font-size: 6rem;
            }
            
            .source-card {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .summary-container {
                padding: 1.25rem;
            }

            .upgrade-prompt {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-cookie">🍪</div>
        <h2 style="color: #8b4513;">Loading Cookiejar...</h2>
        <p style="color: #666; margin-top: 0.5rem;">Checking authentication</p>
    </div>

    <header class="header" id="mainHeader" style="display: none;">
        <div class="header-content">
            <div class="logo">
                <div class="cookie-icon">🍪</div>
                Cookiejar
            </div>
            <div class="user-info">
                <div class="user-email" id="userEmail">Loading...</div>
                <div class="credits">
                    <span id="reportsRemaining">Loading...</span> reports remaining
                    <span class="tier-badge" id="tierBadge">FREE</span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="main-container" id="mainContent" style="display: none;">
        <!-- Research Input Section -->
        <div class="research-card research-input-section" id="input-section">
            <h1>What would you like to research?</h1>
            <p>Enter your research question and we'll create a comprehensive, cited report using academic sources.</p>
            
            <div class="input-container">
                <textarea 
                    class="research-input" 
                    id="research-question"
                    placeholder="e.g., 'Impact of social media on teenage mental health' or 'Latest developments in quantum computing applications'"
                    maxlength="500"
                ></textarea>
                
                <div class="input-validation" id="input-validation"></div>
            </div>
            
            <div class="input-actions">
                <button class="btn btn-primary" id="start-research" onclick="performResearch()" disabled>
                    Enter research question
                </button>
                <button class="btn btn-secondary" onclick="showExamples()">
                    See Examples
                </button>
            </div>

            <!-- Upgrade prompt for limit exceeded -->
            <div id="upgradePrompt" class="upgrade-prompt">
                <h3>🚀 Usage Limit Reached!</h3>
                <p>You've used all 3 free reports this month. Upgrade to continue researching with unlimited access to academic sources.</p>
                <button class="btn" style="background: white; color: #8b4513; margin-top: 1rem; border: none; padding: 1rem 2rem; border-radius: 10px; font-weight: 600;">
                    Upgrade to Starter Plan - $7/month
                </button>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="research-card processing-section" id="processing-section">
            <div class="cookie-container">
                <div class="cookie" id="cookie">🍪</div>
            </div>
            
            <h2>Researching your question...</h2>
            <p>Gathering knowledge, one bite at a time 🍪</p>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-text" id="progress-text">Starting research...</div>
            
            <div class="processing-steps">
                <div class="processing-step" id="step-1">
                    <div class="step-icon">1</div>
                    <span>Analyzing your research question</span>
                </div>
                <div class="processing-step" id="step-2">
                    <div class="step-icon">2</div>
                    <span>Searching academic databases</span>
                </div>
                <div class="processing-step" id="step-3">
                    <div class="step-icon">3</div>
                    <span>Finding relevant sources</span>
                </div>
                <div class="processing-step" id="step-4">
                    <div class="step-icon">4</div>
                    <span>Synthesizing findings</span>
                </div>
                <div class="processing-step" id="step-5">
                    <div class="step-icon">5</div>
                    <span>Generating citations</span>
                </div>
                <div class="processing-step" id="step-6">
                    <div class="step-icon">6</div>
                    <span>Creating report</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="research-card results-section" id="results-section">
            <div id="results"></div>
        </div>
    </div>

    <!-- Firebase SDK for Authentication Only -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoP3cMo1gFGx2LVqFtVyDLQvaedqHmf4E",
            authDomain: "cookiejar-b639e.firebaseapp.com",
            projectId: "cookiejar-b639e",
            storageBucket: "cookiejar-b639e.firebasestorage.app",
            messagingSenderId: "1062366176100",
            appId: "1:1062366176100:web:a0f584bc58746dddcb1071",
            measurementId: "G-XBRZR7KS0R"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let currentUser = null;
        let userUsageData = { remaining: 3, used: 0, limit: 3 };

        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please refresh the page and try again.');
            }
        };

        // Authentication check and initial usage load
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainHeader = document.getElementById('mainHeader');
            const mainContent = document.getElementById('mainContent');
            const userEmail = document.getElementById('userEmail');

            if (user) {
                console.log('User is authenticated:', user.email);
                currentUser = user;
                
                if (userEmail) {
                    userEmail.textContent = user.email;
                }

                // Load initial usage data from backend
                await loadUserUsage();
                
                // Show main app
                loadingScreen.style.display = 'none';
                mainHeader.style.display = 'block';
                mainContent.style.display = 'block';
                
            } else {
                console.log('User not authenticated, redirecting to login');
                window.location.href = 'index.html';
            }
        });

        // Load user usage data from backend
        async function loadUserUsage() {
            try {
                const response = await fetch('https://cookiejar-api.vercel.app/api/usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUser.uid,
                        action: 'check'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    userUsageData = {
                        remaining: data.remaining || 3,
                        used: data.used || 0,
                        limit: data.limit || 3
                    };
                    updateUsageDisplay();
                } else {
                    console.warn('Failed to load usage data, using defaults');
                    updateUsageDisplay();
                }
            } catch (error) {
                console.warn('Error loading usage data:', error);
                updateUsageDisplay();
            }
        }

        window.getCurrentUser = () => currentUser;
        window.getUserUsage = () => userUsageData;
    </script>

    <script>
        let currentStep = 0;
        let processingInterval = null;

        // Input validation
        function validateResearchInput(question) {
            const issues = [];
            const trimmed = question.trim();
            
            if (trimmed.length === 0) {
                return { isValid: false, issues: ['Please enter a research question'] };
            }
            
            if (trimmed.length < 10) {
                issues.push("Question too short - add more detail (minimum 10 characters)");
            }
            
            if (trimmed.length > 500) {
                issues.push("Question too long - please shorten (maximum 500 characters)");
            }
            
            const wordCount = trimmed.split(/\s+/).length;
            if (wordCount < 3) {
                issues.push("Use at least 3 words to describe your research topic");
            }
            
            // Check for unsafe content patterns
            const unsafePatterns = [
                /\b(suicide|self-harm|kill myself)\b/i,
                /\b(bomb|explosive|weapon|attack)\b/i,
                /\b(illegal drugs|drug dealing)\b/i,
                /\b(hack|hacking|exploit|bypass)\b/i
            ];
            
            if (unsafePatterns.some(pattern => pattern.test(trimmed))) {
                issues.push("This topic cannot be researched due to content policy");
            }
            
            return {
                isValid: issues.length === 0,
                issues: issues
            };
        }

        // Update input validation display
        function updateValidationDisplay(validation) {
            const validationContainer = document.getElementById('input-validation');
            
            if (!validation.isValid && validation.issues.length > 0) {
                validationContainer.innerHTML = validation.issues.map(issue => 
                    `<div class="validation-message validation-error">${issue}</div>`
                ).join('');
            } else if (validation.isValid) {
                validationContainer.innerHTML = '<div class="validation-message validation-success">✓ Ready to research</div>';
            } else {
                validationContainer.innerHTML = '';
            }
        }

        // Update usage display in header
        function updateUsageDisplay(remaining = null) {
            const reportsRemainingElement = document.getElementById('reportsRemaining');
            const researchButton = document.getElementById('start-research');
            
            if (remaining !== null) {
                window.getUserUsage().remaining = Math.max(0, remaining);
            }
            
            const currentRemaining = window.getUserUsage().remaining;
            
            if (reportsRemainingElement) {
                reportsRemainingElement.textContent = currentRemaining;
            }
            
            // Disable button if no reports remaining
            if (currentRemaining <= 0 && researchButton) {
                researchButton.disabled = true;
                researchButton.textContent = 'Monthly Limit Reached - Upgrade to Continue';
                researchButton.style.background = 'linear-gradient(45deg, #ccc, #999)';
            }
        }

        // Research function with proper error handling
        async function performResearch() {
            const question = document.getElementById('research-question').value.trim();
            const validation = validateResearchInput(question);
            
            if (!validation.isValid) {
                updateValidationDisplay(validation);
                return;
            }

            const user = window.getCurrentUser();
            if (!user) {
                alert('Please refresh the page and try again');
                return;
            }

            // Check usage before starting
            const usage = window.getUserUsage();
            if (usage.remaining <= 0) {
                showUpgradePrompt({ 
                    error: 'You have used all 3 free reports this month.',
                    remaining: 0 
                });
                return;
            }

            showResearchProgress();

            try {
                const response = await fetch('https://cookiejar-api.vercel.app/api/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        question: question,
                        userId: user.uid,
                        tier: 'free'
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle specific usage limit errors
                    if (data.code === 'USAGE_LIMIT_EXCEEDED') {
                        hideResearchProgress();
                        showUpgradePrompt(data);
                        return;
                    }
                    
                    // Handle other errors
                    throw new Error(data.error || `Server error: ${response.status}`);
                }
                
                // Success - display results
                displayResults(data);
                
                // Update the usage counter
                if (typeof data.metadata?.remainingReports === 'number') {
                    updateUsageDisplay(data.metadata.remainingReports);
                }
                
            } catch (error) {
                console.error('Research failed:', error);
                hideResearchProgress();
                
                let errorMessage = 'An unexpected error occurred.';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Request timed out. Please try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <h3>Research Failed</h3>
                        <p>${errorMessage}</p>
                        <p style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="startNewResearch()">Try Again</button>
                        </p>
                    </div>
                `;
                document.getElementById('results-section').style.display = 'block';
            }
        }

        function showUpgradePrompt(errorData) {
            const upgradePrompt = document.getElementById('upgradePrompt');
            if (upgradePrompt) {
                upgradePrompt.style.display = 'block';
                
                // Scroll to the prompt
                upgradePrompt.scrollIntoView({ behavior: 'smooth' });
                
                // Update the counter display
                updateUsageDisplay(0);
                
                // Update message if provided
                if (errorData && errorData.error) {
                    const messageElement = upgradePrompt.querySelector('p');
                    if (messageElement) {
                        messageElement.textContent = errorData.error + ' Upgrade to continue researching with unlimited access to academic sources.';
                    }
                }
            }
        }

        function showResearchProgress() {
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('processing-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            
            simulateProcessingWithProgress();
        }

        function hideResearchProgress() {
            if (processingInterval) {
                clearInterval(processingInterval);
                processingInterval = null;
            }
        }

        // Enhanced processing simulation with progress bar
        function simulateProcessingWithProgress() {
            currentStep = 0;
            const stepElements = document.querySelectorAll('.processing-step');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            stepElements.forEach(step => {
                step.classList.remove('active', 'completed');
            });

            const stepMessages = [
                'Analyzing your research question...',
                'Searching PubMed database...',
                'Searching arXiv papers...',
                'Searching CrossRef database...',
                'Synthesizing findings with AI...',
                'Generating citations and report...'
            ];

            if (stepElements.length > 0) {
                stepElements[0].classList.add('active');
                currentStep = 1;
                progressText.textContent = stepMessages[0];
                progressBar.style.width = '16%';
            }

            processingInterval = setInterval(() => {
                if (currentStep > 1) {
                    stepElements[currentStep - 2].classList.remove('active');
                    stepElements[currentStep - 2].classList.add('completed');
                }
                
                if (currentStep < stepElements.length) {
                    stepElements[currentStep].classList.add('active');
                    progressText.textContent = stepMessages[currentStep] || 'Processing...';
                    progressBar.style.width = `${Math.round((currentStep + 1) / stepElements.length * 100)}%`;
                    currentStep++;
                } else {
                    stepElements[stepElements.length - 1].classList.remove('active');
                    stepElements[stepElements.length - 1].classList.add('completed');
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Completing research...';
                    clearInterval(processingInterval);
                    processingInterval = null;
                }
            }, 2000); // Slightly slower for better UX
        }

        // Format summary with better structure
        function formatSummary(summary) {
            const sections = [];
            const paragraphs = summary.split('\n\n').filter(p => p.trim().length > 0);
            
            let formattedContent = '';
            
            paragraphs.forEach((paragraph, index) => {
                const trimmed = paragraph.trim();
                
                if (trimmed.match(/^\*\*.*?\*\*/)) {
                    // Extract heading and content
                    const headingMatch = trimmed.match(/^\*\*(.*?)\*\*:?\s*(.*)/s);
                    if (headingMatch) {
                        const title = headingMatch[1].trim();
                        const content = headingMatch[2].trim();
                        
                        formattedContent += `
                            <div class="summary-section">
                                <h4 class="summary-heading">${title}</h4>
                                <div class="summary-content">${content}</div>
                            </div>
                        `;
                    }
                } else {
                    formattedContent += `
                        <div class="summary-section">
                            <div class="summary-content">${trimmed}</div>
                        </div>
                    `;
                }
            });
            
            return `
                <div class="research-summary-header">
                    <h3>Research Summary</h3>
                </div>
                <div class="summary-container">
                    ${formattedContent}
                </div>
            `;
        }

        function displayResults(data) {
            hideResearchProgress();
            document.getElementById('processing-section').style.display = 'none';
            
            const formattedSummary = formatSummary(data.summary || 'Research summary not available.');
            
            const resultsHtml = `
                <div class="result-header">
                    <div class="result-title">${data.title || 'Research Results'}</div>
                    <div class="result-meta">Generated ${data.processingTime || 'just now'}</div>
                </div>
                
                <div class="result-stats">
                    <div class="stat">
                        <div class="stat-number">${data.sources?.length || 0}</div>
                        <div class="stat-label">Sources Found</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${Math.ceil((data.summary?.length || 0) / 500)}</div>
                        <div class="stat-label">Pages Generated</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${data.sources ? data.sources.length : 0}</div>
                        <div class="stat-label">Citations</div>
                    </div>
                </div>

                ${formattedSummary}

                ${data.sources && data.sources.length > 0 ? `
                    <div class="sources-section">
                        <h3>All Sources (${data.sources.length})</h3>
                        <div class="sources-grid">
                            ${data.sources.map((source, index) => `
                                <div class="source-card">
                                    <div class="source-number">[${index + 1}]</div>
                                    <div class="source-content">
                                        <div class="source-title">${source.title}</div>
                                        <div class="source-meta">${source.source} ${source.year ? '(' + source.year + ')' : ''}</div>
                                        <div class="source-authors">${source.authors}</div>
                                        ${source.quote ? `<div class="source-quote">"${source.quote.substring(0, 150)}${source.quote.length > 150 ? '...' : ''}"</div>` : ''}
                                        <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="source-link">View Source →</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '<p>No sources found for this query.</p>'}

                <div class="download-section">
                    <h3>Your Research Report is Ready!</h3>
                    <p>Professional report with citations and methodology</p>
                    <div style="margin-top: 1rem;">
                        <button class="btn" style="background: white; color: #8b4513; margin-right: 1rem;" onclick="downloadPDF('${data.title}')">
                            📄 Download PDF (Coming Soon)
                        </button>
                        <button class="btn" style="background: transparent; border: 2px solid white; color: white;" onclick="emailReport('${data.title}')">
                            📧 Email Report (Coming Soon)
                        </button>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="startNewResearch()" style="margin-top: 1rem;">
                    Start New Research
                </button>
            `;
            
            document.getElementById('results').innerHTML = resultsHtml;
            document.getElementById('results-section').style.display = 'block';
            
            // Scroll to results
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function startNewResearch() {
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('research-question').value = '';
            document.getElementById('research-question').focus();
            document.getElementById('input-validation').innerHTML = '';
            
            // Reset button state
            const button = document.getElementById('start-research');
            button.disabled = true;
            button.textContent = 'Enter research question';
            button.style.background = '';
            
            // Hide upgrade prompt if it was shown
            const upgradePrompt = document.getElementById('upgradePrompt');
            if (upgradePrompt) {
                upgradePrompt.style.display = 'none';
            }
        }

        function showExamples() {
            const examples = [
                'Impact of artificial intelligence on job displacement in healthcare',
                'Effectiveness of meditation on anxiety reduction in college students',
                'Climate change effects on coral reef ecosystems in the Pacific',
                'Blockchain technology applications in supply chain management',
                'Remote learning effectiveness during COVID-19 pandemic',
                'CRISPR gene editing ethical implications and regulations',
                'Microplastics impact on marine food chains',
                'Social media influence on teenage mental health outcomes'
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('research-question').value = randomExample;
            
            // Trigger validation
            const event = new Event('input', { bubbles: true });
            document.getElementById('research-question').dispatchEvent(event);
        }

        // Placeholder functions for future features
        function downloadPDF(title) {
            alert('PDF download feature coming soon! This will generate a professionally formatted PDF of your research report.');
        }

        function emailReport(title) {
            alert('Email feature coming soon! This will send your research report to your email address.');
        }

        // Input event listener for real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const researchInput = document.getElementById('research-question');
            const researchButton = document.getElementById('start-research');
            
            researchInput.addEventListener('input', function() {
                const question = this.value;
                const validation = validateResearchInput(question);
                const usage = window.getUserUsage();
                
                updateValidationDisplay(validation);
                
                // Update button state
                if (validation.isValid && usage.remaining > 0) {
                    researchButton.disabled = false;
                    researchButton.textContent = 'Generate Research Report';
                    researchButton.style.background = '';
                } else if (usage.remaining <= 0) {
                    researchButton.disabled = true;
                    researchButton.textContent = 'Monthly Limit Reached - Upgrade to Continue';
                    researchButton.style.background = 'linear-gradient(45deg, #ccc, #999)';
                } else if (validation.issues.length > 0) {
                    researchButton.disabled = true;
                    researchButton.textContent = validation.issues[0].substring(0, 50) + (validation.issues[0].length > 50 ? '...' : '');
                    researchButton.style.background = '';
                } else {
                    researchButton.disabled = true;
                    researchButton.textContent = 'Enter research question';
                    researchButton.style.background = '';
                }
                
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.max(80, this.scrollHeight) + 'px';
            });
            
            // Enter key handling
            researchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    if (!researchButton.disabled) {
                        performResearch();
                    }
                }
            });
        });

        // Error handling for network issues
        window.addEventListener('online', function() {
            console.log('Connection restored');
            // Could show a notification here
        });

        window.addEventListener('offline', function() {
            console.log('Connection lost');
            alert('Internet connection lost. Please check your connection and try again.');
        });

        // Prevent multiple concurrent requests
        let isResearching = false;
        const originalPerformResearch = performResearch;
        
        performResearch = async function() {
            if (isResearching) {
                console.log('Research already in progress, ignoring duplicate request');
                return;
            }
            
            isResearching = true;
            try {
                await originalPerformResearch();
            } finally {
                isResearching = false;
            }
        };
    </script>
</body>
</html>
